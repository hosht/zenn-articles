---
title: "OpenTelemetryã®Client instrumentation for the browserã‚’è©¦ã—ãŸ"
emoji: "ğŸ”­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [opentelemetry]
published: false
---

ã“ã®è¨˜äº‹ã¯OpenTelemetry Advent Calendar 2024ã®20æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://qiita.com/advent-calendar/2024/opentelemetry


## ã¯ã˜ã‚ã«

OpenTelemetry(Otel)ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¨ˆæ¸¬ã™ã‚‹æ©Ÿèƒ½ãŒé–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚
2024å¹´12æœˆç¾åœ¨ã¯å®Ÿé¨“çš„æ©Ÿèƒ½ã®ä½ç½®ä»˜ã‘ã«ãªã‚Šã¾ã™ãŒã€å®Ÿéš›ã«è©¦ã—ã¦ç¾æ™‚ç‚¹ã§ã®å®Ÿè£…å…·åˆã‚’è¦‹ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚

:::message alert
ã“ã“ã§ç´¹ä»‹ã—ã¦ã„ã‚‹å†…å®¹ã¯å°†æ¥å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
:::

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹

Otel JavaScript SDKã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã«Browserå‘ã‘ã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚
https://opentelemetry.io/docs/languages/js/getting-started/browser/

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Document Load Instrumentation Example</title>
    <base href="/" />
    <meta
      name="traceparent"
      content="00-ab42124a3c573678d4d8b21ba52df3bf-d21f7bc17caa5aba-01"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    Example of using Web Tracer with document load instrumentation with console
    exporter and collector exporter
    <script type="module" src="document-load.js"></script>
  </body>
</html>
```
![]()
*index.html*

```javascript
import {
  ConsoleSpanExporter,
  SimpleSpanProcessor,
} from '@opentelemetry/sdk-trace-base';
import { WebTracerProvider } from '@opentelemetry/sdk-trace-web';
import { DocumentLoadInstrumentation } from '@opentelemetry/instrumentation-document-load';
import { ZoneContextManager } from '@opentelemetry/context-zone';
import { registerInstrumentations } from '@opentelemetry/instrumentation';

// Spanã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
const provider = new WebTracerProvider({
  spanProcessors: [new SimpleSpanProcessor(new ConsoleSpanExporter())],
});

provider.register({
  contextManager: new ZoneContextManager(),
});

// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚’è¨ˆæ¸¬
registerInstrumentations({
  instrumentations: [new DocumentLoadInstrumentation()],
});
```
![]()
*document-load.js*

```json
{
  "name": "otel-browser",
  "main": "index.js",
  "dependencies": {
    "@opentelemetry/api": "^1.9.0",
    "@opentelemetry/context-zone": "^1.30.0",
    "@opentelemetry/instrumentation-document-load": "^0.44.0",
    "@opentelemetry/sdk-trace-web": "^1.30.0"
  },
  "devDependencies": {
    "vite": "^6.0.5"
  }
}
```
![]()
*package.json*


```shell
$ npm install
$ npx vite
$ open http://localhost:5173
```

viteã®devãƒ¢ãƒ¼ãƒ‰ã‚’èµ·å‹•ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶é–‹ãã¾ã™ã€‚
Chrome devtoolsã®Consoleã«attributeã‚„eventã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![](/images/otel_browser/console.png)

## å¯è¦–åŒ–ã—ã¦ã¿ã‚‹

ã“ã®ã¾ã¾ã§ã¯æƒ…å ±ã¨ã—ã¦åˆ©ç”¨ä¾¡å€¤ãŒä½ã„ãŸã‚ã€å¯è¦–åŒ–ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚
Otelã®Browserã«å¯¾å¿œã—ãŸReal User Monitoringã®SaaSã¯ã¾ã å°‘ãªã„ã§ã™ãŒã€ãã®ä¸­ã‹ã‚‰Grafana Faroã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚^[èª¿ã¹ãŸç¯„å›²ã§ã¯Honeycombã‚‚å¯¾å¿œã—ã¦ã„ã¾ã—ãŸãŒã€Enterprise Planã®ã¿ã§æä¾›ã•ã‚Œã¦ã„ãŸãŸã‚ä»Šå›ã¯è©¦ã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ]

https://grafana.com/oss/faro/

å‰è¿°ã®document-load.jsã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
Grafana Faroã«Traceã‚’é€ä¿¡ã™ã‚‹ã«ã¯å°‚ç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ãŒå¿…è¦ã§ã—ãŸã€‚

```shell
$ npm i @grafana/faro-web-sdk @grafana/faro-web-tracing
```

```javascript
import { trace, context } from '@opentelemetry/api';
import {
  ConsoleSpanExporter,
  SimpleSpanProcessor,
  BatchSpanProcessor,
} from '@opentelemetry/sdk-trace-base';
import { WebTracerProvider } from '@opentelemetry/sdk-trace-web';
import { DocumentLoadInstrumentation } from '@opentelemetry/instrumentation-document-load';
import { ZoneContextManager } from '@opentelemetry/context-zone';
import { registerInstrumentations } from '@opentelemetry/instrumentation';
import { initializeFaro } from '@grafana/faro-web-sdk';
import { FaroTraceExporter, FaroSessionSpanProcessor } from '@grafana/faro-web-tracing';

const faro = initializeFaro({
  url: 'https://faro-collector-prod-ap-northeast-0.grafana.net/collect/xxxxxx',
  app: {
    name: "otel-web-demo",
    version: "1.0.0",
    environment: "production",
  }
});

const provider = new WebTracerProvider({
  spanProcessors: [
    new SimpleSpanProcessor(new ConsoleSpanExporter()),
    new FaroSessionSpanProcessor(
      new BatchSpanProcessor(new FaroTraceExporter({ ...faro })),
      faro.metas
    ),
  ],
});

provider.register({
  contextManager: new ZoneContextManager(),
});

registerInstrumentations({
  instrumentations: [new DocumentLoadInstrumentation()],
});

faro.api.initOTEL(trace, context);
```
![]()
*document-load.js*

å…ˆã»ã©ã¨åŒæ§˜ã«viteã®devãƒ¢ãƒ¼ãƒ‰ã‚’èµ·å‹•ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ãã¾ã™ã€‚^[Otelã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«parcelã‚’æ¡ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€@grafana/faro-web-tracingã‚’è¿½åŠ ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§viteã«å¤‰æ›´ã—ã¾ã—ãŸ]

```shell
$ npx vite
$ open http://localhost:5173
```

Grafana Faraã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã™ã€‚
Core Web Vitalã®å„ç¨®æ•°å€¤ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚^[ä»Šå›ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã ã‘ã§ã™ãŒã€Otelã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§Clickã‚„fetchãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¨ˆæ¸¬ã§ãã¾ã™ã€‚]
![](/images/otel_browser/user_journey.png)

Otelã®åˆ©ç”¨è€…ã«ã¯ãŠé¦´æŸ“ã¿ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã®ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ã‚°ãƒ©ãƒ•ã‚‚ç¢ºèªã§ãã¾ã—ãŸã€‚

![](/images/otel_browser/waterfall.png)

## æ‰€æ„Ÿ

OpenTelemetryã§ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è¨ˆæ¸¬ã§ãã¾ã—ãŸã€‚
SaaSãƒ™ãƒ³ãƒ€ãƒ¼ãŒæä¾›ã™ã‚‹RUMã¨æ¯”è¼ƒã™ã‚‹ã¨ã¾ã æ©Ÿèƒ½ä¸è¶³ãªå°è±¡ã§ã™ãŒã€ [Client Instrumentation SIG](https://docs.google.com/document/d/16Vsdh-DM72AfMg_FIt9yT9ExEWF4A_vRbQ3jRNBe09w)ã§æ´»ç™ºã«è­°è«–ãŒã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‹ã‚‰ã«æœŸå¾…ã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚
