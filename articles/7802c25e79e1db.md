---
title: "Node.js on Dockerã§ã‚¹ãƒªãƒ ã‹ã¤ã‚»ã‚­ãƒ¥ã‚¢ãªã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ - 2025å¹´ç‰ˆ"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["docker", "nodejs", "pnpm", "typescript"]
published: false
publication_name: "bitkey_dev"
---

## ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã¯Dockerfileã‚’æ›¸ã„ã¦ã„ã¾ã™ã‹ï¼Ÿ
è¿‘å¹´ã¯AIã«ã‚ˆã‚‹æ”¯æ´ã§Dockerfileã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒã§æ›¸ãæ©Ÿä¼šãŒæ¸›ã£ã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ã—ã‹ã—ãªãŒã‚‰ã€AIã«æ›¸ã‹ã›ã‚‹å ´åˆã§ã‚‚è‰¯ã„æ›¸ãæ–¹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã“ã¨ã§ã€ãã®å¾Œã®ä¿®æ­£ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Dockerfileã‚’ä½œæˆã™ã‚‹éš›ã«ã€ç§ãªã‚‰ã“ã®ã‚ˆã†ã«æ›¸ãã¨ã„ã†ææ¡ˆã‚’ã—ã¾ã™ã€‚

## ä½œæˆã™ã‚‹Dockerfileã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

åˆã‚ã«ã€å®Œæˆå½¢ã®Dockerfileã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ç¤ºã—ã¾ã™ã€‚
ä»¥é™ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

å®Ÿè¡Œå¯èƒ½ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯GitHubã§å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã“ã¡ã‚‰ã‚‚å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://github.com/hosht/node-docker-example-for-zenn-article

### Dockerfile

å„ç¨®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã®æœ€æ–°ç‰ˆã§ã™ã€‚

```Dockerfile
# syntax=docker/dockerfile:1.19.0
FROM node:24.11.0-bookworm-slim AS builder
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable pnpm
WORKDIR /app
COPY pnpm-lock.yaml /app
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm fetch
COPY . /app
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --offline
RUN pnpm run build
RUN pnpm prune --prod --ignore-scripts

FROM gcr.io/distroless/nodejs24-debian12:nonroot AS app
ENV NODE_ENV=production
WORKDIR /app
COPY --from=builder --chown=nonroot:nonroot /app/dist /app/dist
COPY --from=builder --chown=nonroot:nonroot /app/node_modules /app/node_modules
COPY --from=builder --chown=nonroot:nonroot /app/package.json /app/package.json
ENV NODE_OPTIONS="--enable-source-maps"
CMD ["dist/index.js"]
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ LICENSE
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ index.ts
â””â”€â”€ tsconfig.json
```

## Dockerfileå…¨è¡Œè§£èª¬

```Dockerfile
# syntax=docker/dockerfile:1.19.0
```

Dockerfileã®æ§‹æ–‡ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å›ºå®šã«ã“ã ã‚ã‚ŠãŒãªã‘ã‚Œã°`docker/dockerfile:1`ã«ã—ã¾ã™ã€‚

```Dockerfile
FROM node:24.11.0-bookworm-slim AS builder
```

Node.jsã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã¯24.11.0-bookworm-slimã«ã—ã¦ã„ã¾ã™ãŒã€ãŠå¥½ã¿ã§ãƒãƒƒã‚·ãƒ¥å€¤ã«ã—ã¾ã™ã€‚

```Dockerfile
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
```
pnpmãŒä»Šå›ã®æ§‹æˆã§ä¸­å¿ƒçš„å½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚

```Dockerfile
RUN corepack enable pnpm
```

corepackã‚’ä½¿ã£ã¦pnpmã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
package.jsonã®packageManagerãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§pnpmã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

:::message
Node.js 25ä»¥é™ã§ã¯corepackã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«åŒæ¢±ã•ã‚Œãªã„ãŸã‚åˆ¥é€”ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚
:::

```Dockerfile
WORKDIR /app
COPY pnpm-lock.yaml /app
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm fetch
```

å…ˆè¡Œã—ã¦pnpm-lock.yamlã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰ã€`pnpm fetch`ã®æº–å‚™ã‚’ã—ã¾ã™ã€‚
`pnpm fetch`ã¯pnpm-lock.yamlã®å†…å®¹ã«åŸºã¥ã„ã¦ä»®æƒ³ã‚¹ãƒˆã‚¢ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
package.jsonã«ä¾å­˜ã—ãªã„ãŸã‚ã€package.jsonã«å¤‰æ›´ãŒãªã„å ´åˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ãã‚„ã™ããªã‚Šã¾ã™ã€‚
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚è¨€åŠã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆã«å½¹ç«‹ã¤ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
https://pnpm.io/cli/fetch
`--mount=type=cache,id=pnpm,target=/pnpm/store`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€å®Ÿè¡Œç’°å¢ƒã«ã‚ˆã£ã¦ã¯ãƒ“ãƒ«ãƒ‰æ¯ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

```Dockerfile
COPY . /app
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --offline
```

`pnpm fetch`ã§å…ˆè¡Œã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
`--offline`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã‚ãšé«˜é€Ÿã«å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚

```Dockerfile
RUN pnpm run build
RUN pnpm prune --prod --ignore-scripts
```

ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã®node_modulesã¯å®Ÿè¡Œç’°å¢ƒã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã§`pnpm prune --prod`ã§devDependenciesã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```Dockerfile
FROM gcr.io/distroless/nodejs24-debian12:nonroot AS app
```

å®Ÿè¡Œç’°å¢ƒã«ã¯Distrolessã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
Distrolessã¯nonrootã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€åˆ©ç”¨å¯èƒ½ãªå ´é¢ã§ã¯ç©æ¥µçš„ã«æ¡ç”¨ã—ã¾ã™ã€‚

```Dockerfile
ENV NODE_ENV=production
WORKDIR /app
COPY --from=builder --chown=nonroot:nonroot /app/dist /app/dist
COPY --from=builder --chown=nonroot:nonroot /app/node_modules /app/node_modules
COPY --from=builder --chown=nonroot:nonroot /app/package.json /app/package.json
```

ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
`--chown=nonroot:nonroot`ã‚’æŒ‡å®šã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ã‚’nonrootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´ã—ã¾ã™ã€‚

```Dockerfile
ENV NODE_OPTIONS="--enable-source-maps"
CMD ["dist/index.js"]
```

`--enable-source-maps`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®æƒ…å ±ã‚’å«ã‚ã¾ã™ã€‚
CMDã¯package.jsonã®mainãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨˜è¼‰ã—ã¦ã„ã‚‹å ´åˆã¯`["."]`ã§ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ã‚’æŒ‡å®šå¯èƒ½ã§ã™ã€‚

## ãŠã‚ã‚Šã«

ã“ã®è¨˜äº‹ã¯pnpmå…¬å¼ã®Working with Dockerã‚’å‚è€ƒã«Dockerfileã‚’ä½œæˆã—ãŸã¨ã“ã‚ã€ç´°ã‹ã„æ”¹å–„ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã£ãŸãŸã‚ã€æ”¹ä¿®ã‚’åŠ ãˆãŸå†…å®¹ã«ãªã‚Šã¾ã™ã€‚
pnpmã¯æ©Ÿèƒ½è¿½åŠ ãŒé »ç¹ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ãŸã‚ãƒªãƒªãƒ¼ã‚¹ã‚’ç¶™ç¶šçš„ã«ã‚¦ã‚©ãƒƒãƒã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
https://pnpm.io/docker


ã“ã®è¨˜äº‹ã¯Node.jsã€TypeScriptã€pnpmã‚’å‰æã¨ã—ãŸå†…å®¹ã«ãªã‚Šã¾ã™ãŒã€ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚„ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚‚å–ã‚Šå…¥ã‚Œã‚‰ã‚Œã‚‹è€ƒãˆæ–¹ã‚„æ‰‹æ³•ãŒã‚ã‚‹ã®ã§å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## Appendix

- https://github.com/pnpm/pnpm/releases
- https://github.com/moby/buildkit/releases
- https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/reference.md
- https://docs.docker.com/reference/dockerfile/
- https://github.com/GoogleContainerTools/distroless
